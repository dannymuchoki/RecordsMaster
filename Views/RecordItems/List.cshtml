@model RecordsMaster.Utilities.PaginatedList<RecordsMaster.Models.RecordItemModel>

@{
    ViewData["Title"] = "Record Items";
}

@if (!User.IsInRole("Admin"))
{
    <p>Access Denied</p>
}
else
{
    <h1>Records</h1>

    @if (TempData["SuccessMessage"] != null)
    {
        var hasPdf = TempData["PdfFileName"] != null;
        var pdfFileName = TempData["PdfFileName"] as string;
        var successMessage = TempData["SuccessMessage"] as string;

        // Keep TempData for the next request so the download button persists through page reloads
        TempData.Keep("PdfFileName");
        TempData.Keep("SuccessMessage");

        <div class="alert alert-success @(hasPdf ? "" : "alert-dismissible") fade show" role="alert" id="pdfAlert">
            @successMessage
            @if (hasPdf)
            {
                <br />
                <a href="@Url.Action("DownloadPdf", "Upload", new { fileName = pdfFileName })" class="btn btn-primary mt-2">
                    Download Labels PDF
                </a>
                <button type="button" class="btn btn-sm btn-secondary mt-2 ml-2" id="dismissPdfAlert">
                    Dismiss
                </button>
            }
            @if (!hasPdf)
            {
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            }
        </div>
    }

    <div class="form-group mt-3">
        <label for="filterDropdown">Filter Records:</label>
        <select id="filterDropdown" class="form-control">
            <option value="all">All</option>
            <option value="checkedOut">Checked Out Only</option>
        </select>
    </div>

    <div id="recordsContainer">
        @await Html.PartialAsync("_RecordsTable", Model)
    </div>

    <!-- Pagination controls -->
    <div id="paginationControls">
        @if (Model.TotalPages > 1)
        {
            <nav>
                <ul class="pagination">
                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                        <a class="page-link" 
                           asp-route-pageNumber="@(Model.PageIndex - 1)" 
                           aria-disabled="@(Model.HasPreviousPage ? "false" : "true")">
                           Previous
                        </a>
                    </li>

                    <li class='page-item disabled'>
                        <span class='page-link'>
                            Page @Model.PageIndex of @Model.TotalPages
                        </span>
                    </li>

                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                        <a class="page-link" 
                           asp-route-pageNumber="@(Model.PageIndex + 1)" 
                           aria-disabled="@(Model.HasNextPage ? "false" : "true")">
                           Next
                        </a>
                    </li>
                </ul>
            </nav>
        }
    </div>
    <div id='downloadCsv'> 
        <form asp-action="DownloadCsv" asp-controller="RecordItems" method="post" style="display:inline;">
        <button type="submit" name="download" value="download" class="btn btn-sm btn-primary">Download All</button>
    </form>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var filterDropdown = document.getElementById('filterDropdown');
            var recordsContainer = document.getElementById('recordsContainer');
            var paginationControls = document.getElementById('paginationControls');
            var downloadCsvDiv = document.getElementById('downloadCsv');

            filterDropdown.addEventListener('change', function () {
                var filter = filterDropdown.value;

                if (filter === 'all'){
                    paginationControls.style.display = 'block';
                    downloadCsvDiv.style.display = 'block';
                    window.location.reload();
                    return;
                }

                var xhr = new XMLHttpRequest();
                var url = '@Url.Action("GetCheckedOutRecords","RecordItems")?filter=' +encodeURIComponent(filter);

                xhr.open('GET', url, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                        recordsContainer.innerHTML = xhr.responseText;

                        // Hide pagination controls and download csv when filtering.-- 
                        if (filter === "checkedOut") {
                            paginationControls.style.display = 'none';
                            downloadCsvDiv.style.display = 'none';
                        } else {
                            paginationControls.style.display = 'block';
                            downloadCsvDiv.style.display = 'block';
                            
                        }
                    }
                };

                xhr.send();
            });

            // Handle PDF alert dismiss button
            var dismissPdfAlertBtn = document.getElementById('dismissPdfAlert');
            if (dismissPdfAlertBtn) {
                dismissPdfAlertBtn.addEventListener('click', function () {
                    // Get CSRF token
                    var token = document.querySelector('input[name="__RequestVerificationToken"]');
                    var tokenValue = token ? token.value : '';

                    // Make AJAX call to clear TempData
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '@Url.Action("ClearPdfAlert", "RecordItems")', true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                            // Hide the alert
                            var pdfAlert = document.getElementById('pdfAlert');
                            if (pdfAlert) {
                                pdfAlert.style.display = 'none';
                            }
                        }
                    };

                    // Send CSRF token in request body
                    xhr.send('__RequestVerificationToken=' + encodeURIComponent(tokenValue));
                });
            }
        });
    </script>
}